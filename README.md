# 3D NPH Indicators

正常壓力型水腦症（Normal Pressure Hydrocephalus, NPH）3D 影像指標計算工具

## 主要功能

### 1. 腦室質心距離計算

- 自動載入左右腦室的分割影像（NIfTI 格式）
- 在物理空間（世界座標系統）中計算左右腦室的質心位置
- 計算左右腦室質心之間的 3D 歐式距離

### 2. 顱內橫向寬度測量

- 自動計算顱內橫向最大寬度
- 在每個 Z 切面上測量，取得最大值
- 記錄最大寬度位置的切面編號和端點座標

### 3. NPH 關鍵指標計算

- 計算腦室質心距離與顱內寬度的比值
- 提供小數和百分比兩種表示形式
- 此比值可作為 NPH 診斷的重要參考指標

### 4. 3D 視覺化

- 產生互動式 3D 視覺化圖表（HTML 格式）
- 靜態圖片輸出（PNG 格式）
- 視覺化內容包括：
  - 腦部表面網格（半透明灰色）
  - 左右腦室點雲（藍色與紅色）
  - 腦室質心標記（鑽石形狀）
  - 腦室質心連線（金色，標註距離）
  - 顱內橫向寬度連線（青色，標註寬度）
  - 完整的測量數據顯示於標題

## 專案結構

```plaintext
3d-nph-indicators/
├── main.py                    # 主程式入口
├── model/
│   ├── calculation.py         # 計算模組（質心、距離、寬度、比值）
│   ├── visualization.py       # 視覺化模組（3D 圖表、摘要輸出）
│   └── reorient.py            # 影像處理工具（座標轉換等）
├── result/                    # 輸出結果目錄
│   ├── *.png                  # 靜態視覺化圖片
│   └── *.html                 # 互動式 3D 圖表
├── requirements.txt           # Python 依賴套件
└── README.md                  # 專案說明文件
```

## 安裝與環境設定

### 系統需求

- Python 3.8 或以上版本
- 建議使用虛擬環境

### 安裝步驟

1. 複製專案到本地端

```bash
git clone <repository-url>
cd 3d-nph-indicators
```

2. 建立並啟動虛擬環境（建議）

```bash
python3 -m venv env
source env/bin/activate  # macOS/Linux
# 或
env\Scripts\activate  # Windows
```

3. 安裝依賴套件

```bash
pip install -r requirements.txt
```

### 依賴套件說明

- `nibabel >= 5.0.0`: 讀取和處理 NIfTI 格式的醫學影像
- `numpy >= 1.24.0`: 數值計算和陣列操作
- `plotly >= 5.17.0`: 產生互動式 3D 視覺化圖表
- `kaleido >= 0.2.1`: 將 Plotly 圖表匯出為靜態圖片
- `scikit-image >= 0.21.0`: 影像處理（Marching Cubes 演算法）

## 使用方法

### 準備資料

確保你有以下 NIfTI 格式的影像檔案：

- `Ventricle_L.nii.gz` - 左腦室分割影像
- `Ventricle_R.nii.gz` - 右腦室分割影像
- `original.nii.gz` - 原始腦部影像（用於視覺化背景）

將這些檔案放在資料目錄中（例如：`000016209E/`）

### 執行程式

1. 修改 `main.py` 中的資料目錄設定：

```python
data_dir = "你的資料目錄名稱"
```

2. 執行主程式：

```bash
python main.py
```

### 輸出結果

程式執行完成後，會在 `result/` 目錄中產生：

1. **PNG 圖片** (`{data_dir}_ventricle_distance.png`)
   - 高解析度 3D 視覺化靜態圖片
   - 尺寸：1200 x 900 像素
   - 包含所有測量數據的標題

2. **互動式 HTML** (`{data_dir}_ventricle_distance.html`)
   - 可在瀏覽器中開啟
   - 支援 360° 旋轉、縮放、平移
   - 可切換顯示/隱藏不同的圖層

3. **終端輸出摘要**
   - 左右腦室質心座標
   - 腦室質心距離
   - 顱內橫向最大寬度
   - 腦室距離/顱內寬度比值

## 輸出範例

```plaintext
======================================================================
3D NPH 指標計算 - 腦室質心距離分析
======================================================================

步驟 1: 載入左右腦室影像
----------------------------------------------------------------------

載入左腦室: 000016209E/Ventricle_L.nii.gz
  影像形狀: (512, 512, 29)
  方向: ('R', 'A', 'S')
  體素間距: (0.4297, 0.4297, 5.0)

載入右腦室: 000016209E/Ventricle_R.nii.gz
  影像形狀: (512, 512, 29)
  方向: ('R', 'A', 'S')
  體素間距: (0.4297, 0.4297, 5.0)

✓ 影像形狀相同
✓ 座標系統驗證通過！將在物理空間中計算。

步驟 2: 計算左右腦室質心距離
----------------------------------------------------------------------

步驟 3: 計算顱內橫向最大寬度
----------------------------------------------------------------------

計算顱內橫向最大寬度...

顱內橫向最大寬度: 142.35 mm
位置: Z 切面 #15
左端點座標 (mm): (-71.18, 25.43, 75.00)
右端點座標 (mm): (71.17, 28.76, 75.00)

步驟 4: 計算腦室距離與顱內寬度的比值
----------------------------------------------------------------------
腦室距離/顱內寬度比值: 0.2543 (25.43%)

======================================================================
腦室質心距離測量結果
======================================================================

左腦室質心座標 (mm): (25.67, 18.32, 85.23)
右腦室質心座標 (mm): (-10.45, 20.18, 82.67)

體素間距 (mm): 0.4297 x 0.4297 x 5.00

左右腦室質心距離: 36.21 mm
顱內橫向最大寬度: 142.35 mm

腦室距離/顱內寬度比值: 0.2543 (25.43%)
======================================================================
```

## 技術細節

### 座標系統處理

- 所有計算均在物理空間（世界座標系統）中進行
- 使用 NIfTI affine 矩陣進行體素空間到物理空間的轉換
- 支援不同方向（RAS, LAS 等）的影像
- 確保左右腦室影像座標系統一致性

### 質心計算方法

- 採用加權質心演算法
- 使用體素強度值作為權重
- 提高計算精確度

### 視覺化技術

- Marching Cubes 演算法提取腦部表面
- 點雲方式呈現腦室結構
- 使用 Plotly 產生互動式 WebGL 圖表
- Kaleido 引擎將圖表轉換為高品質 PNG
