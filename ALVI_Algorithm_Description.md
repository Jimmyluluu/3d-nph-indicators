# ALVI (Anteroposterior Lateral Ventricle Index) 演算法說明

本文檔詳細說明 ALVI 指標中「腦室前後徑」與「顱骨前後徑」的自動化計算演算法。

> **最新更新**: 
> 1. 左右腦室改為**完全獨立計算** (包含 Z 軸範圍篩選)。
> 2. 腦室前後徑取左右側的**最大值** (而非平均值)，以反映最嚴重的擴大程度。

## 1. 腦室前後徑 (Ventricle AP Diameter) 計算演算法

為了避免人為選擇切面的誤差，本系統採用 **PCA (主成分分析)** 配合 **SVD (奇異值分解)** 方法，自動尋找腦室的自然長軸。

### 步驟流程：

1.  **分離左右腦室**
    *   分別讀取左腦室 (`Ventricle_L`) 和右腦室 (`Ventricle_R`) 的二值化遮罩影像。
    *   將體素座標 (Voxel Coordinates) 轉換為物理空間座標 (Physical Coordinates, RAS+)，確保單位為 mm。
    *   **連通區域分析 (Connected Component Analysis)**:
        *   對二值化影像執行連通區域標記。
        *   僅保留**體積最大**的連通區域，自動移除因分割誤差產生的懸浮噪聲島 (Floating Islands)。

2.  **單側腦室長軸計算 (對左右側分別獨立執行)**
    
    對於每一側腦室：
    
    *   **定義體部區域 (Body Region)**
        *   統計該側腦室點雲在 Z 軸 (由下往上) 的分布。
        *   計算 Z 軸的 **30% 分位數 ($Z_{30}$) ** 與 **70% 分位數 ($Z_{70}$)**。
        *   **定義**：僅保留 Z 軸座標介於 $[Z_{30}, Z_{70}]$ 之間的點作為「腦室體部」。
        *   *目的*：排除前角 (Frontal Horn) 向外彎曲與後角 (Occipital Horn) 向外分叉的部分，專注於測量體部的直線距離。
    
    *   **PCA 主軸計算**
        *   **中心化 (Centering)**：計算重心，將體部點雲平移。
        *   **SVD 分解**：進行奇異值分解 (Singular Value Decomposition) 找出**第一主成分方向 (Principal Axis)**，代表該側腦室的最長軸走向。
    
    *   **投影測量**
        *   將體部點雲投影到主軸向量上。
        *   **過濾離群值**:
            *   計算投影值的 **0.5 百分位數** ($P_{0.5}$) 與 **99.5 百分位數** ($P_{99.5}$)。
            *   此步驟能有效排除分割誤差造成的零星噪聲點 (Outliers)。
        *   **計算長徑**：使用過濾後的範圍計算長徑 ($D_{side} = P_{99.5} - P_{0.5}$)。

3.  **最終結果選取**
    *   比較左腦室長徑 ($D_{left}$) 與右腦室長徑 ($D_{right}$)。
    *   **腦室前後徑 ($D_{ventricle}$)** 取兩者的**最大值**：
        $$ D_{ventricle} = \max(D_{left}, D_{right}) $$
    *   同時記錄該最大值側的 Z 軸範圍 $[Z_{start}, Z_{end}]$ 用於後續顱骨測量。

---

## 2. 顱骨前後徑 (Skull AP Diameter) 計算演算法

此指標代表在與**最大腦室側相同的高度範圍內**，顱骨內部的最大前後距離。

### 步驟流程：

1.  **定義測量範圍**
    *   使用在腦室計算步驟中，被選為最大值的那一側腦室的 Z 軸範圍 $[Z_{start}, Z_{end}]$。

2.  **篩選原始影像**
    *   讀取原始腦部影像 (`original`)。
    *   篩選出所有非零點 (Non-zero pixels，即腦組織區域)，且 Z 軸座標介於 $[Z_{start}, Z_{end}]$ 之間的點集。

3.  **計算 Y 軸最大距離**
    *   在篩選出的點集中，找出 Y 軸 (Posterior-Anterior 方向) 的最大值 $Y_{max}$ 與最小值 $Y_{min}$。
    *   **顱骨前後徑 ($D_{skull}$)**：
        $$ D_{skull} = Y_{max} - Y_{min} $$

---

## 3. ALVI 指標計算

$$ ALVI = \frac{D_{ventricle}}{D_{skull}} $$

*   **$D_{ventricle}$**: 腦室前後徑 (mm, 左右側最大值)
*   **$D_{skull}$**: 顱骨前後徑 (mm, 同高度測量)

此演算法確保了測量是基於 3D 幾何結構的自然對齊，並針對每個腦室的獨特型態進行了獨立的最佳化測量。
